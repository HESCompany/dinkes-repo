{% extends "base.html" %}
{% block title %}Beranda - Repositori File{% endblock %}
{% block content %}
<h1>Repositori File</h1>
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="collapse" data-bs-target="#searchFilters" aria-expanded="false" aria-controls="searchFilters">
    Cari!!..
</button>
<div id="searchFilters" class="collapse mb-4">
    <form method="GET" action="{{ url_for('index') }}">
        <div class="row g-3">
            <div class="col-md-6">
                <label for="judul" class="form-label">Judul</label>
                <input type="text" class="form-control" id="judul" name="judul" value="{{ query_params.judul }}">
            </div>
            <div class="col-md-3">
                <label for="date_from" class="form-label">Tanggal Dari</label>
                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ query_params.date_from }}">
            </div>
            <div class="col-md-3">
                <label for="date_to" class="form-label">Tanggal Sampai</label>
                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ query_params.date_to }}">
            </div>
            <div class="col-md-4">
                <label for="nama_penulis" class="form-label">Nama Penulis</label>
                <input type="text" class="form-control" id="nama_penulis" name="nama_penulis" value="{{ query_params.nama_penulis }}">
            </div>
            <div class="col-md-4">
                <label for="nim" class="form-label">NIM</label>
                <input type="text" class="form-control" id="nim" name="nim" value="{{ query_params.nim }}">
            </div>
            <div class="col-md-4">
                <label for="university_name" class="form-label">Universitas</label>
                <input type="text" class="form-control" id="university_name" name="university_name" value="{{ query_params.university_name }}">
            </div>
            <div class="col-md-4">
                <label for="major" class="form-label">Prodi</label>
                <input type="text" class="form-control" id="major" name="major" value="{{ query_params.major }}">
            </div>
            <div class="col-md-4">
                <label for="uploaded_by" class="form-label">Diunggah Oleh</label>
                <input type="text" class="form-control" id="uploaded_by" name="uploaded_by" value="{{ query_params.uploaded_by }}">
            </div>
            <div class="col-md-4">
                <label for="file_type" class="form-label">Tipe File</label>
                <select class="form-select" id="file_type" name="file_type">
                    <option value="">Semua Tipe File</option>
                    <option value="pdf" {% if query_params.file_type == 'pdf' %}selected{% endif %}>PDF</option>
                    <option value="jpg" {% if query_params.file_type == 'jpg' %}selected{% endif %}>JPG</option>
                    <option value="jpeg" {% if query_params.file_type == 'jpeg' %}selected{% endif %}>JPEG</option>
                    <option value="png" {% if query_params.file_type == 'png' %}selected{% endif %}>PNG</option>
                </select>
            </div>
            <div class="col-md-12">
                <label class="form-label">Tag</label>
                <div class="d-flex flex-wrap gap-2">
                    {% for tag in ["Tesis", "Disertasi", "Laporan Penelitian", "Jurnal", "Makalah", "Proposal"] %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="tags" value="{{ tag }}" id="tag_{{ tag }}" {% if tag in query_params.tags %}checked{% endif %}>
                        <label class="form-check-label" for="tag_{{ tag }}">
                            {{ tag }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-success">Cari</button>
            </div>
        </div>
    </form>
</div>
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Tanggal Unggah</th>
                <th>Nama Penulis</th>
                <th>NIM</th>
                <th>Universitas</th>
                <th>Prodi</th>
                <th>Judul</th>
                <th>Tag</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% if not files.items %}
            <tr>
                <td colspan="8" class="text-center">Tidak ada file yang ditemukan.</td>
            </tr>
            {% else %}
            {% for file in files.items %}
            <tr>
                <td>{{ file.display_upload_date }}</td>
                <td>{{ file.nama_penulis }}</td>
                <td>{{ file.nim }}</td>
                <td>{{ file.university_name }}</td>
                <td>{{ file.major }}</td>
                <td>{{ file.judul }}</td>
                <td>
                    {% if file.tags %}
                    {{ file.tags.replace(',', ', ') }}
                    {% else %}
                    Tidak ada tag
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group" role="group" aria-label="File actions">
                        <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-primary btn-sm">Unduh</a>
                        {% if current_user.is_authenticated and file.uploader.id == current_user.id %}
                        <form action="{{ url_for('delete_file', file_id=file.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Apakah Anda yakin ingin menghapus file ini?');">Hapus</button>
                        </form>
                        {% endif %}
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#fileDetailsModal" onclick="loadFileDetails({{ file.id }})">Detail</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>
<!-- Pagination -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if files.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('index', page=files.prev_num, **query_params) }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% endif %}
        {% for page_num in files.iter_pages() %}
        {% if page_num %}
        <li class="page-item {% if page_num == files.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('index', page=page_num, **query_params) }}">{{ page_num }}</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endfor %}
        {% if files.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('index', page=files.next_num, **query_params) }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>

<!-- Upload File Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Unggah File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">File (PDF, JPG, JPEG, PNG saja)</label>
                        <input type="file" class="form-control" id="file" name="file" required accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="mb-3">
                        <label for="judul" class="form-label">Judul</label>
                        <input type="text" class="form-control" id="judul" name="judul" required>
                    </div>
                    <div class="mb-3">
                        <label for="nama_penulis" class="form-label">Nama Penulis</label>
                        <input type="text" class="form-control" id="nama_penulis" name="nama_penulis" required>
                    </div>
                    <div class="mb-3">
                        <label for="nim" class="form-label">NIM</label>
                        <input type="text" class="form-control" id="nim" name="nim" required>
                    </div>
                    <div class="mb-3">
                        <label for="university_name" class="form-label">Universitas</label>
                        <input type="text" class="form-control" id="university_name" name="university_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="major" class="form-label">Prodi</label>
                        <input type="text" class="form-control" id="major" name="major" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tag</label>
                        <div class="d-flex flex-wrap gap-2">
                            {% for tag in ["Tesis", "Disertasi", "Laporan Penelitian", "Jurnal", "Makalah", "Proposal"] %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tags" value="{{ tag }}" id="upload_tag_{{ tag }}">
                                <label class="form-check-label" for="upload_tag_{{ tag }}">
                                    {{ tag }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Unggah</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for File Details -->
<div class="modal fade" id="fileDetailsModal" tabindex="-1" aria-labelledby="fileDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileDetailsModalLabel">Detail File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Judul:</strong> <span id="modal-judul"></span></p>
                <p><strong>Tanggal Unggah:</strong> <span id="modal-upload-date"></span></p>
                <p><strong>Nama Penulis:</strong> <span id="modal-nama-penulis"></span></p>
                <p><strong>NIM:</strong> <span id="modal-nim"></span></p>
                <p><strong>Universitas:</strong> <span id="modal-university-name"></span></p>
                <p><strong>Prodi:</strong> <span id="modal-major"></span></p>
                <p><strong>Tag:</strong> <span id="modal-tags"></span></p>
                <p><strong>Tipe File:</strong> <span id="modal-file-type"></span></p>
                <p><strong>Ukuran File:</strong> <span id="modal-file-size"></span> KB</p>
                <p><strong>Diunggah Oleh:</strong> <span id="modal-uploader"></span></p>
                <p><strong>Pratinjau:</strong></p>
                <div id="modal-preview-content" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <a id="modal-download-link" class="btn btn-primary" href="#">Unduh</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<script>
function loadFileDetails(fileId) {
    fetch(`/file-details/${fileId}`)
        .then(response => response.json())
        .then(file => {
            document.getElementById('modal-judul').innerText = file.judul || 'N/A';
            document.getElementById('modal-upload-date').innerText = new Date(file.upload_date).toLocaleString();
            document.getElementById('modal-nama-penulis').innerText = file.nama_penulis || 'N/A';
            document.getElementById('modal-nim').innerText = file.nim || 'N/A';
            document.getElementById('modal-university-name').innerText = file.university_name || 'N/A';
            document.getElementById('modal-major').innerText = file.major || 'N/A';
            document.getElementById('modal-tags').innerText = file.tags ? file.tags.replace(',', ', ') : 'Tidak ada tag';
            document.getElementById('modal-file-type').innerText = file.file_type || 'Tidak diketahui';
            document.getElementById('modal-file-size').innerText = (file.file_size / 1024).toFixed(2);
            document.getElementById('modal-uploader').innerText = file.uploader_username || 'Tidak diketahui';

            const previewContentDiv = document.getElementById('modal-preview-content');
            previewContentDiv.innerHTML = ''; // Clear previous content

            if (file.file_type === 'pdf') {
                const pdfEmbed = document.createElement('embed');
                pdfEmbed.src = `/preview/${file.id}`;
                pdfEmbed.type = 'application/pdf';
                pdfEmbed.width = '100%';
                pdfEmbed.height = '600px';
                previewContentDiv.appendChild(pdfEmbed);
            } else if (['jpg', 'jpeg', 'png'].includes(file.file_type)) {
                const previewImg = document.createElement('img');
                previewImg.src = `/preview/${file.id}`;
                previewImg.alt = 'Pratinjau File';
                previewImg.style.maxWidth = '100%';
                previewContentDiv.appendChild(previewImg);
            } else {
                previewContentDiv.innerText = 'Pratinjau tidak tersedia untuk tipe file ini.';
            }

            document.getElementById('modal-download-link').href = `/download/${file.id}`;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat memuat detail file.');
        });
}
</script>
{% endblock %}

